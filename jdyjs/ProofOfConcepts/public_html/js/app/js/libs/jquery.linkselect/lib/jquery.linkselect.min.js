/*
 * Linkselect jQuery Plug-in
 *
 * Copyright 2012 Giva, Inc. (http://www.givainc.com/labs/) 
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 * 	http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Date: 2012-09-11
 * Rev:  1.5.10
 */
(function(B){B.linkselect={version:"1.5.10"};B.fn.linkselect=function(F){var G=typeof arguments[0]=="string"&&arguments[0];var E=G&&Array.prototype.slice.call(arguments,1)||arguments;if(G&&this.length){var D=B.data(this[0],"linkselect");if(G.toLowerCase()=="object"){return D}else{if(D[G]){var C;this.each(function(H){var I=B.data(this,"linkselect")[G].apply(D,E);if(H==0&&I){if(!!I.jquery){C=B([]).add(I)}else{C=I;return false}}else{if(!!I&&!!I.jquery){C=C.add(I)}}});return C||this}else{return this}}}else{return this.each(function(){new B.LinkSelect(this,F)})}};var A=0;B.LinkSelect=function(r,V){V=B.extend({},B.LinkSelect.defaults,V);if(V.style.length==0){V.style=B.LinkSelect.defaults.style}V.classes={link:V.style+"-link",linkText:V.style+"-link-text",linkOpen:V.style+"-link-open",linkIcon:V.style+"-link-icon",linkFocus:V.style+"-link-focus",container:V.style+"-container",selected:V.style+"-selected",current:V.style+"-current",disabled:V.style+"-disabled",scrollable:V.style+"-scrollable",title:V.style+"-title",value:V.style+"-value",placeholder:"placeholder"};var J=this,K=++A,l=r,s=B(r),a={},d=false,N=0,c,F=false,b;this.id=s.attr("id");this.val=function(x,w){if(arguments.length>0){m(x,w);return M}else{return e.val()}};this.text=function(){return U().find("span."+V.classes.value).text()};this.change=function(){U().trigger("click.linkselect",[true,true]);return M};this.focus=function(){setTimeout(function(){M.focus()},1);return M};this.blur=function(){setTimeout(function(){M.blur()},1);return M};this.open=function(x,w){if(d){return M}B(document).triggerHandler("click.linkselect");if(w!==false){M.trigger("focus")}setTimeout(function(){k(x)},1);return M};this.disable=function(w){d=w;M.parent().find("span."+V.classes.disabled).remove();M[d?"hide":"show"]();if(d){M.after('<span class="'+V.classes.disabled+'">'+M.html()+"</span>")}return M};this.destroy=function(){W.undelegate("li","*");M.unbind("*");o();M.before(s);f.remove()};this.replaceOptions=function(y,AA,z){var w=(typeof AA==="string");if(!w&&!z){z=AA}var x=s.children("option");if(w&&AA.length){x=x.not(AA)}x.remove();B.each(y,function(AB){var AC=B("<option/>").attr("value",this.value).html(this.text);if(this.selected==true){AC.attr("selected","selected")}if(this.className){AC.addClass(this.className)}AC.appendTo(s)});Q();U().trigger("click.linkselect",[true,z])};var f=t();s.after(f).remove();var e=f.filter("input"),M=f.filter("a"),v=M.find("> span."+V.classes.linkText),H=f.filter("div"),R=f.find("."+V.classes.scrollable),I=f.find("."+V.classes.title),W=H.find("ul"),Y;S();e.addClass(s.attr("class"));B.data(e[0],"linkselect",this);H.appendTo("body").bind("mousemove.linkselect",function(w){Y=w});W.delegate("li","mouseover.linkselect",function(w){if(Y&&Y.type=="keydown"){return }i(B(this));Y=w}).delegate("li","click.linkselect",function(AB,x,AA){AB.preventDefault();var w=U().removeClass(V.classes.selected),y=B(this).addClass(V.classes.selected),z=y.attr("data-value")||"",AC=y.find("."+V.classes.value).html();G(x);e.val(z);if((AA!==false)&&((B.isFunction(V.change)&&(V.change.apply(J,[this,z,AC,AA])===false))||(B.isFunction(s[0].onchange)&&(s[0].onchange.apply(J,[this,z,AC,AA])===false)))){w.addClass(V.classes.selected);y.removeClass(V.classes.selected);e.val(w.attr("data-value")||"");return }v.html(AC);M[(x!==true)?"trigger":"triggerHandler"]("focus",[x]);if(d){M.parent().find("span."+V.classes.disabled).html(AC)}});M.bind("click.linkselect",function(w){w.preventDefault();j();setTimeout(function(){M.trigger("focus.linkselect")},0)}).bind("focus.linkselect",function(x,w){if(!H.is(":visible")&&(w!==true)){M.addClass(V.classes.linkFocus)}}).bind("blur.linkselect",function(w){if(u(w)){G()}M.removeClass(V.classes.linkFocus)}).bind((B.browser.safari?"keydown":"keypress")+".linkselect",function(AB,AA){if(!!AA){var AB=AA}var x=AB.keyCode||AB.charCode,z=String.fromCharCode(x).toLowerCase();switch(x){case 38:case 40:AB.preventDefault();g((x==38)?-1:1,true);Y=AB;break;case 13:AB.preventDefault();if(H.is(":visible")){H.find("li."+V.classes.current).trigger("click.linkselect")}else{M.trigger("click.linkselect")}break;case 9:case 27:G();break;case 35:AB.preventDefault();O();Y=AB;break;case 36:AB.preventDefault();Z();Y=AB;break;case 33:case 34:AB.preventDefault();var w=H.is(":visible");if(!w){H.show()}var y=parseInt(R.height()/W.find("li:not(."+V.classes.placeholder+"):first").outerHeight(),10);if(!w){H.hide()}g(y*((x==33)?-1:1));break}if(z!=c){N=0}c=z;if(typeof a[z]!="undefined"){if(N>=a[z].length){N=0}W.find("#"+J.id+"_li_"+a[z][N]).trigger("click.linkselect");AB.preventDefault();AB.stopPropagation();N++}});if(B.browser.msie){M.bind("keydown.linkselect",function(w){if(",8,9,33,34,35,36,37,38,39,40,".indexOf(","+w.keyCode+",")>-1){return B(this).triggerHandler("keypress.linkselect",[w])}})}function T(){B(document).bind("click.linkselect-"+K,function(x){var y=B(x.target);if((y.closest("a")[0]!==M[0])&&(y[0]!==R[0])&&H.is(":visible")){G();if(b&&(y.closest("."+V.classes.title)[0]===I[0])){L()}var w=y.closest(H);if(w.length){setTimeout(function(){M.trigger("focus.linkselect")},13)}else{M.removeClass(V.classes.linkFocus)}}});B(window).bind("resize.linkselect-"+K,function(){P(M,H)})}function o(){B(document).unbind("click.linkselect-"+K);B(window).unbind("resize.linkselect-"+K)}function t(){var AB=J.id,x=s.attr("name")||AB,AA=l.selectedIndex==-1?"":l[l.selectedIndex].text,z=l.selectedIndex==-1?"":l[l.selectedIndex][(B.browser.msie&&B.browser.version<=7&&!(l[l.selectedIndex].attributes.value.specified))?"text":"value"],y=s.attr("tabindex");var w=['<a href="#'+J.id+'" id="'+J.id+'_link" class="'+B.trim(V.classes.link+" "+V.classLink)+'"'+(y?' tabindex="'+y+'"':"")+">",'<span class="'+V.classes.linkText+'">',AA,"</span>",'<span class="'+V.classes.linkIcon+'"><span></span></span>',"</a>",'<input type="hidden" name="'+x+'" id="'+J.id+'" value="'+z+'" />','<div class="'+V.classes.container+'">','<div class="'+V.classes.title+'"><span></span></div>','<div class="'+V.classes.scrollable+'"><ul id="'+J.id+'_list">',n(s.children("option")),"</ul></div>","</div>"];return B(w.join(""))}function n(w){a=[],b=w.filter("."+V.classes.placeholder).eq(0);if(b.length==0){b=null}var x=[];w.each(function(AA){var AE=B(this);var AC=AE.is(":selected");var y=B.trim(AE.text());var z='<span class="'+V.classes.value+'">'+y+"</span>";var AD=B.browser.msie&&B.browser.version<=7&&!(this.attributes.value.specified)?this.text:this.value;if(B.isFunction(V.format)){z=V.format.apply(J,[z,AD,y,AA,AE,V])||z}if(!b||b[0]!==AE[0]){var AB=(y.length>1)?y.substring(0,1).toLowerCase():"";if(!a[AB]){a[AB]=[]}a[AB].push(AA)}var AF=B.trim(this.className+" "+(AC?V.classes.selected:""));x.push('<li id="'+J.id+"_li_"+AA+'" data-value="'+AD+(AF.length>0?'" class="'+AF:"")+'">'+z+"</li>")});return x.join("")}function Q(){E=false;H[0].style.width="";if(I.length){I[0].style.width="";I.css("float","")}W.html(n(s.children("option")));if(b){S()}}function S(){var w=B.trim(s.attr("title")||(b&&b.text())||"");I[w.length?"show":"hide"]()[b?"addClass":"removeClass"](V.classes.placeholder).find("span").text(w)}function L(){if(b){W.find("li."+V.classes.placeholder).trigger("click.linkselect")}}function m(y,x){var w=W.find("li[data-value='"+y+"']");if(w.length==0){w=W.find("li:eq(0)")}return w.trigger("click.linkselect",[true,x])}function U(){var w=W.find("li."+V.classes.selected);if(w.length==0){w=W.find("li:eq(0)")}return w}function X(){var w=W.find("li."+V.classes.current);if(w.length==0){w=U()}return w}function i(w){H.find("."+V.classes.current).removeClass(V.classes.current);return p(w)}function p(w){w.addClass(V.classes.current);if(b){I[w.hasClass(V.classes.placeholder)?"addClass":"removeClass"](V.classes.current)}return w}function g(x,y){var w=X();var z=parseInt(w.attr("id").replace(/(.+)(_(\d+$))/gi,"$3"),10);if(b&&(y!==true)&&w.hasClass(V.classes.placeholder)){z++}D(z+x,y)}function D(AA,y){var z=H.find("li"),w;if(!z||z.length==0){return false}var x=X().removeClass(V.classes.current);if(isNaN(AA)||AA<0){AA=0}else{if(AA>z.length-1){AA=z.length-1}}w=z.eq(AA);if(b&&(y!==true)&&w.hasClass(V.classes.placeholder)){w=z.eq(AA+1)}if(H.is(":visible")){p(w);C(w)}else{if(x[0]!==w[0]){w.trigger("click.linkselect")}}}function Z(){D(0)}function O(){D(H.find("li").length-1)}function C(x,w){var z=x[0];var AA=R[0];var y={pTop:parseInt(R.css("paddingTop"),10)||0,pBottom:parseInt(R.css("paddingBottom"),10)||0,bTop:parseInt(R.css("borderTopWidth"),10)||0,bBottom:parseInt(R.css("borderBottomWidth"),10)||0};if((z.offsetTop+z.offsetHeight)>(AA.scrollTop+AA.clientHeight)){AA.scrollTop=x.offset().top+(AA.scrollTop-R.offset().top)-((AA.clientHeight/((w==true)?2:1))-(x.outerHeight()+y.pBottom))}else{if(z.offsetTop-y.bTop-y.bBottom<=(AA.scrollTop+y.pTop+y.pBottom)){AA.scrollTop=x.offset().top+(AA.scrollTop-R.offset().top)-y.pTop}}}function j(){var w=H.is(":visible");if(w){G()}else{k()}return w}var E=false;function k(AD){T();var y=U(),x=!E;M.removeClass(V.classes.linkFocus).addClass(V.classes.linkOpen);H.show();if(!E){var AC=(M.css("display").indexOf("inline")>-1)?M.parent().outerWidth(true):M.outerWidth(true);var z=V.fixedWidth?AC:H.outerWidth(true);if(z<AC){z=AC}var AB=parseInt(R.css("max-height"),10);if(B.browser.msie&&B.browser.version<=6){if((AB>0)&&(R.height()>AB)){R.height(AB)}}if(W.height()>AB){z+=25}var AA=parseInt("0"+H.css("max-width"),10);if((AA>0)&&(z>AA)){z=AC=AA}H.width(z);if(B.browser.safari){var w=H.width();if(AC>w){z=AC=w}}AC=AC-((parseInt(I.css("marginRight"),10)||0)-(parseInt(I.css("marginLeft"),10)||0));I.width(AC);if(I.outerWidth()>AC){I.width(AC-(I.outerWidth()-AC))}if(V.titleAlign.toLowerCase()=="right"&&!V.fixedWidth){I.css("float","right")}E=true}P(M,H,x);if(!!B.fn.bgIframe){H.bgIframe()}C(y,true);i(y);if(B.isFunction(V.open)){V.open.apply(this,[H,M,y,I])}if(B.isFunction(AD)){AD.apply(this,[H,M,y,I])}F=true}function G(w){o();if(w!==true){M.addClass(V.classes.linkFocus).removeClass(V.classes.linkOpen)}H.hide();if(B.isFunction(V.close)){V.close.apply(this,[H,M,U(),I])}F=false}function h(w){var x=false;if(w.is(":hidden")){x=!!w.css("visibility","hidden").show()}var y=B.extend(w.offset(),{width:w.outerWidth(),height:w.outerHeight(),marginLeft:parseInt(B.curCSS(w[0],"marginLeft",true),10)||0,marginRight:parseInt(B.curCSS(w[0],"marginRight",true),10)||0,marginTop:parseInt(B.curCSS(w[0],"marginTop",true),10)||0,marginBottom:parseInt(B.curCSS(w[0],"marginBottom",true),10)||0,paddingLeft:parseInt(B.curCSS(w[0],"paddingLeft",true),10)||0,paddingRight:parseInt(B.curCSS(w[0],"paddingRight",true),10)||0,borderLeftWidth:parseInt(B.curCSS(w[0],"borderLeftWidth",true),10)||0,borderRightWidth:parseInt(B.curCSS(w[0],"borderRightWidth",true),10)||0});if(y.marginTop<0){y.top+=y.marginTop}if(y.marginLeft<0){y.left+=y.marginLeft}y.bottom=y.top+y.height;y.right=y.left+y.width;if(x){w.hide().css("visibility","visible")}return y}function P(AE,w,z){var AB=h(AE);var y=q();var AD=H.outerWidth()+AB.left;if(AD>y.x){var AA=AB.paddingLeft+AB.paddingRight+AB.borderLeftWidth+AB.borderRightWidth;if(z){I.width(I.width()-AA)}AB.left=(AB.left+AA-H.outerWidth())+I.outerWidth(true)}else{var AC=H.width(),x=I.outerWidth(true);if(AC>x){I.width(AC-(x-I.width()))}}w.css({position:"absolute",top:AB[V.yAxis],left:AB.left});return AB.bottom}function q(){var w={scrollLeft:B(window).scrollLeft(),scrollTop:B(window).scrollTop(),width:B("body").width(),height:B("body").height()};w.x=w.scrollLeft+w.width;w.y=w.scrollTop+w.height;return w}function u(w){return !("bubbles" in w||"cancelBubble" in w)}if(B.isFunction(V.init)){V.init.apply(this,[s,e,M,H,R,I,W])}};B.LinkSelect.defaults={style:"linkselect",classLink:"",yAxis:"top",titleAlign:"right",fixedWidth:false,init:null,change:null,format:null,open:null,close:null}})(jQuery);